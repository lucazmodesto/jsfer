<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Pedidos Aprovados</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 25px;
        }
        /* Estilos para o parcelamento */
.parcelamento-section {
    margin-top: 25px;
    border-top: 1px solid #e2e8f0;
    padding-top: 20px;
}

.parcelamento-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.parcelamento-header h3 {
    color: var(--dark);
    font-size: 1.1rem;
}

.parcelamento-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.parcelamento-controls input {
    width: 60px;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    text-align: center;
}

.parcelas-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.parcela-item {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    background-color: #f8fafc;
}

.parcela-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px dashed #e2e8f0;
}

.parcela-numero {
    font-weight: 600;
    color: var(--dark);
}

.parcela-valor {
    font-weight: 600;
    color: var(--primary);
}

.parcela-data-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    margin-top: 5px;
}

.btn-gerar-parcelas {
    padding: 8px 15px;
    background-color: var(--info);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.btn-gerar-parcelas:hover {
    background-color: var(--primary-dark);
}

        h1 {
            text-align: center;
            color: var(--dark);
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .search-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .search-container input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-container button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .search-container button:hover {
            background-color: var(--primary-dark);
        }

        .pedidos-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pedido-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            cursor: pointer;
        }

        .pedido-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .pedido-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .pedido-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-aprovado {
            background-color: var(--success);
            color: white;
        }

        .status-pendente {
            background-color: var(--warning);
            color: white;
        }

        .status-atrasado {
            background-color: var(--danger);
            color: white;
        }

        .pedido-body {
            display: none;
            padding: 20px;
            background-color: white;
        }

        .pedido-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            margin-bottom: 8px;
        }

        .detail-item strong {
            color: var(--dark);
            display: block;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .detail-item span {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .dias-entrega {
            font-weight: 600;
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th, table td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }

        table th {
            background-color: #f8fafc;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.85rem;
        }

        table td {
            font-size: 0.9rem;
        }

        .parcelamento-section {
            margin-top: 25px;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }

        .parcelamento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .parcelamento-header h3 {
            color: var(--dark);
            font-size: 1.1rem;
        }

        .parcelamento-controls {
            display: flex;
            gap: 10px;
        }

        .parcelamento-controls input {
            width: 80px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
        }

        .parcelamento-controls button {
            padding: 8px 15px;
            background-color: var(--info);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .parcelamento-controls button:hover {
            background-color: var(--primary);
        }

        .parcelas-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .parcela-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            background-color: #f8fafc;
        }

        .parcela-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .parcela-numero {
            font-weight: 600;
            color: var(--dark);
        }

        .parcela-valor {
            font-weight: 600;
            color: var(--primary);
        }

        .parcela-data-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-btn {
            background-color: var(--success);
            color: white;
        }

        .save-btn:hover {
            background-color: #3aa8d8;
        }

        .cancel-btn {
            background-color: var(--gray);
            color: white;
        }

        .cancel-btn:hover {
            background-color: #5a6268;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .pedido-details {
                grid-template-columns: 1fr;
            }
            
            .parcelas-container {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                flex-direction: column;
            }
        }

        /* Spinner */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-clipboard-list"></i> Gestão de Pedidos Aprovados</h1>
        
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Buscar por cliente ou número...">
            <button id="search-btn"><i class="fas fa-search"></i> Buscar</button>
        </div>
        
        <div class="pedidos-list" id="pedidos-list">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando pedidos...</p>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        query, 
        where, 
        orderBy,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHKoGOHXhWOax3AUDqzPGRzHBVUK-oMp8",
        authDomain: "novojsfer.firebaseapp.com",
        projectId: "novojsfer",
        storageBucket: "novojsfer.appspot.com",
        messagingSenderId: "610404413021",
        appId: "1:610404413021:web:a6fd70e9a43b68cb22e7b4"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Função para exibir mensagem de erro
    function showError(message) {
        const pedidosList = document.getElementById("pedidos-list");
        pedidosList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erro ao carregar pedidos</h3>
                <p>${message}</p>
                <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Tentar novamente
                </button>
                <div style="margin-top: 10px; font-size: 0.8em; color: var(--gray);">
                    Consulte o console para detalhes técnicos
                </div>
            </div>
        `;
    }

    // Função principal para carregar pedidos
    async function carregarPedidos(busca = "") {
        const pedidosList = document.getElementById("pedidos-list");
        
        try {
            // Mostra estado de carregamento
            pedidosList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando pedidos aprovados...</p>
                </div>
            `;

            // Cria a query base para pedidos aprovados
            let q = query(
                collection(db, "orcamentos"),
                where("status", "==", "aprovado"),
              
            );

            // Executa a consulta
            console.log("Executando query no Firestore...");
            const querySnapshot = await getDocs(q);
            
            // Verifica se há resultados
            if (querySnapshot.empty) {
                pedidosList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Nenhum pedido aprovado encontrado</p>
                        <small>Quando um orçamento for marcado como "aprovado", ele aparecerá aqui.</small>
                    </div>
                `;
                return;
            }

            // Processa os documentos
            console.log(`${querySnapshot.size} pedidos encontrados`);
            pedidosList.innerHTML = ""; // Limpa a lista

            // Filtra por busca se necessário
            const termoBusca = busca.toLowerCase();
            let pedidos = [];
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                // Adiciona verificação de campos obrigatórios
                if (!data.clienteNome) {
                    console.warn(`Pedido ${doc.id} está sem nome de cliente`);
                    data.clienteNome = "Cliente não especificado";
                }
                
                if (!data.totalGeral) {
                    console.warn(`Pedido ${doc.id} está sem valor total`);
                    data.totalGeral = 0;
                }
                
                data.id = doc.id;
                pedidos.push(data);
            });

            // Aplica filtro de busca se houver termo
            if (busca) {
                pedidos = pedidos.filter(pedido => 
                    (pedido.clienteNome && pedido.clienteNome.toLowerCase().includes(termoBusca)) ||
                    (pedido.numero && String(pedido.numero).toLowerCase().includes(termoBusca)) ||
                    (pedido.id && pedido.id.toLowerCase().includes(termoBusca))
                );
                
                if (pedidos.length === 0) {
                    pedidosList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>Nenhum pedido encontrado com "${busca}"</p>
                            <small>Tente buscar por nome do cliente ou número do pedido</small>
                        </div>
                    `;
                    return;
                }
            }

            // Exibe os pedidos
            pedidos.forEach(pedido => {
                const pedidoCard = criarCardPedido(pedido);
                pedidosList.appendChild(pedidoCard);
            });

        } catch (error) {
            console.error("Erro detalhado:", error);
            
            let errorMessage = "Ocorreu um erro ao carregar os pedidos";
            if (error.code === "permission-denied") {
                errorMessage = "Permissão negada. Verifique as regras de segurança do Firestore.";
            } else if (error.code === "unavailable") {
                errorMessage = "Serviço indisponível. Verifique sua conexão com a internet.";
            }
            
            showError(errorMessage);
        }
    }

    // Função para criar o card de um pedido
    function criarCardPedido(pedido) {
        const card = document.createElement("div");
        card.className = "pedido-card";
        
        // Formata os dados com fallbacks
        const numeroPedido = pedido.numero?.toString().padStart(3, '0') || pedido.id.substring(0, 6);
        const clienteNome = pedido.clienteNome || "Cliente não especificado";
        const dataCriacao = formatarData(pedido.dataCriacao);
        const prazoEntrega = formatarData(pedido.prazoEntrega);
        const statusEntrega = calcularStatusEntrega(pedido.prazoEntrega);
        const diasRestantes = calcularDiasRestantes(pedido.prazoEntrega);
        const valorTotal = pedido.totalGeral?.toFixed(2) || "0,00";
        
        // Cria o HTML do card
        card.innerHTML = `
            <div class="pedido-header">
                <h2>Pedido #${numeroPedido}</h2>
                <div class="pedido-info">
                    <span class="pedido-status status-${statusEntrega}">
                        ${statusEntrega === "aprovado" ? "Aprovado" : statusEntrega === "atrasado" ? "Atrasado" : "Pendente"}
                    </span>
                    <span class="dias-entrega">
                        <i class="far fa-calendar-alt"></i> ${diasRestantes}
                    </span>
                </div>
            </div>
            <div class="pedido-body">
                <div class="pedido-details">
                    <div class="detail-item">
                        <strong>Cliente</strong>
                        <span>${clienteNome}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Data de Criação</strong>
                        <span>${dataCriacao}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Data de Entrega</strong>
                        <span>${prazoEntrega}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Valor Total</strong>
                        <span>R$ ${valorTotal}</span>
                    </div>
                </div>

                <h3>Itens do Pedido</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Descrição</th>
                            <th>Qtd.</th>
                            <th>Preço Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <!-- Adicione esta seção após a tabela de itens do pedido, dentro do pedido-body -->
<div class="parcelamento-section">
    <div class="parcelamento-header">
        <h3><i class="fas fa-calendar-alt"></i> Parcelamento</h3>
        <div class="parcelamento-controls">
            <input type="number" id="num-parcelas-${pedido.id}" min="1" max="12" value="1" placeholder="Parcelas">
            <button class="btn-gerar-parcelas" data-pedido-id="${pedido.id}">
                <i class="fas fa-calculator"></i> Gerar
            </button>
        </div>
    </div>
    <div id="parcelas-container-${pedido.id}" class="parcelas-container"></div>
    <div class="action-buttons" id="action-buttons-${pedido.id}" style="display: none;">
        <button class="cancel-btn" data-pedido-id="${pedido.id}">
            <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="save-btn btn-salvar-parcelas" data-pedido-id="${pedido.id}">
            <i class="fas fa-save"></i> Salvar Parcelas
        </button>
    </div>
</div>
                    <tbody>
                        ${pedido.itens?.map(item => `
                            <tr>
                                <td>${item.item || "-"}</td>
                                <td>${item.descricao || "-"}</td>
                                <td>${item.quantidade || 0}</td>
                                <td>R$ ${parseFloat(item.precoUnitario || 0).toFixed(2)}</td>
                                <td>R$ ${parseFloat(item.subtotal || 0).toFixed(2)}</td>
                            </tr>
                        `).join("") || "<tr><td colspan='5'>Nenhum item encontrado</td></tr>"}
                    </tbody>
                </table>
            </div>
        `;

        // Adiciona evento de clique para expandir/recolher
        const header = card.querySelector(".pedido-header");
        const body = card.querySelector(".pedido-body");
        header.addEventListener("click", () => {
            body.style.display = body.style.display === "block" ? "none" : "block";
        });

        return card;
    }

    // Funções auxiliares para formatação
    function formatarData(data) {
        if (!data) return "Não definido";
        
        try {
            // Se for Timestamp do Firestore
            if (data.toDate) {
                return data.toDate().toLocaleDateString('pt-BR');
            }
            // Se for string ISO
            if (typeof data === 'string') {
                return new Date(data).toLocaleDateString('pt-BR');
            }
            // Se for objeto Date
            if (data instanceof Date) {
                return data.toLocaleDateString('pt-BR');
            }
            return "Formato inválido";
        } catch (e) {
            console.error("Erro ao formatar data:", e);
            return "Data inválida";
        }
    }

    function calcularDiasRestantes(dataEntrega) {
        if (!dataEntrega) return "Não definido";
        
        try {
            let dataEntregaObj;
            
            // Se for Timestamp do Firestore
            if (dataEntrega.toDate) {
                dataEntregaObj = dataEntrega.toDate();
            } 
            // Se for string ISO
            else if (typeof dataEntrega === 'string') {
                dataEntregaObj = new Date(dataEntrega);
            }
            // Se for objeto Date
            else if (dataEntrega instanceof Date) {
                dataEntregaObj = dataEntrega;
            } else {
                return "Formato inválido";
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            dataEntregaObj.setHours(0, 0, 0, 0);
            
            const diffTime = dataEntregaObj - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return "Hoje";
            if (diffDays < 0) return `Atrasado (${Math.abs(diffDays)} dias)`;
            return `${diffDays} dias`;
        } catch (e) {
            console.error("Erro ao calcular dias restantes:", e);
            return "Erro no cálculo";
        }
    }
        // Adicione estas funções ao seu módulo

// Função para gerar parcelas
function gerarParcelas(pedidoId, total, numParcelas) {
    const container = document.getElementById(`parcelas-container-${pedidoId}`);
    const actionButtons = document.getElementById(`action-buttons-${pedidoId}`);
    container.innerHTML = '';
    
    // Calcula o valor de cada parcela
    const valorParcela = total / numParcelas;
    
    // Data atual para começar o parcelamento
    const dataAtual = new Date();
    
    for (let i = 0; i < numParcelas; i++) {
        // Calcula a data de vencimento (30 dias entre cada parcela)
        const dataVencimento = new Date(dataAtual);
        dataVencimento.setDate(dataVencimento.getDate() + (i * 30));
        
        // Formata a data para o input type="date"
        const formattedDate = dataVencimento.toISOString().split('T')[0];
        
        const parcelaItem = document.createElement('div');
        parcelaItem.className = 'parcela-item';
        parcelaItem.innerHTML = `
            <div class="parcela-item-header">
                <span class="parcela-numero">Parcela ${String(i + 1).padStart(2, '0')}</span>
                <span class="parcela-valor">R$ ${valorParcela.toFixed(2)}</span>
            </div>
            <input type="date" class="parcela-data-input" value="${formattedDate}" data-parcela-index="${i}">
        `;
        
        container.appendChild(parcelaItem);
    }
    
    actionButtons.style.display = 'flex';
}

// Função para salvar parcelas no calendário de recebimentos
async function salvarParcelas(pedidoId, pedido) {
    const container = document.getElementById(`parcelas-container-${pedidoId}`);
    const inputsData = container.querySelectorAll('.parcela-data-input');
    const numParcelas = inputsData.length;
    const valorParcela = pedido.totalGeral / numParcelas;
    
    try {
        // Para cada data de vencimento, cria um recebimento
        for (let i = 0; i < numParcelas; i++) {
            const dataVencimento = inputsData[i].value;
            
            await addDoc(collection(db, "recebimentos"), {
                descricao: `Parcela ${String(i + 1).padStart(2, '0')} - Pedido #${pedido.numero || pedido.id.substring(0, 6)}`,
                valor: valorParcela,
                dataPagamento: dataVencimento,
                clienteId: pedido.clienteId || null,
                clienteNome: pedido.clienteNome || null,
                telefone: pedido.telefone || null,
                pago: false,
                pedidoId: pedido.id,
                parcelamento: `${i + 1}/${numParcelas}`,
                createdAt: new Date()
            });
        }
        
        alert(`${numParcelas} parcelas foram criadas com sucesso no calendário de recebimentos!`);
        
        // Limpa o container de parcelas
        container.innerHTML = '';
        document.getElementById(`action-buttons-${pedidoId}`).style.display = 'none';
        
    } catch (error) {
        console.error("Erro ao salvar parcelas:", error);
        alert("Erro ao salvar parcelas. Verifique o console para detalhes.");
    }
}

// Event listeners para os botões de parcelamento
document.addEventListener('click', async (e) => {
    // Botão Gerar Parcelas
    if (e.target.classList.contains('btn-gerar-parcelas') || e.target.closest('.btn-gerar-parcelas')) {
        const button = e.target.classList.contains('btn-gerar-parcelas') ? e.target : e.target.closest('.btn-gerar-parcelas');
        const pedidoId = button.getAttribute('data-pedido-id');
        const numParcelas = parseInt(document.getElementById(`num-parcelas-${pedidoId}`).value) || 1;
        
        // Encontra o pedido correspondente
        const q = query(collection(db, "orcamentos"), where("id", "==", pedidoId));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
            const pedido = querySnapshot.docs[0].data();
            gerarParcelas(pedidoId, pedido.totalGeral, numParcelas);
        }
    }
    
    // Botão Salvar Parcelas
    if (e.target.classList.contains('btn-salvar-parcelas') || e.target.closest('.btn-salvar-parcelas')) {
        const button = e.target.classList.contains('btn-salvar-parcelas') ? e.target : e.target.closest('.btn-salvar-parcelas');
        const pedidoId = button.getAttribute('data-pedido-id');
        
        // Encontra o pedido correspondente
        const q = query(collection(db, "orcamentos"), where("id", "==", pedidoId));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
            const pedido = querySnapshot.docs[0].data();
            await salvarParcelas(pedidoId, pedido);
        }
    }
    
    // Botão Cancelar
    if (e.target.classList.contains('cancel-btn') || e.target.closest('.cancel-btn')) {
        const button = e.target.classList.contains('cancel-btn') ? e.target : e.target.closest('.cancel-btn');
        const pedidoId = button.getAttribute('data-pedido-id');
        
        document.getElementById(`parcelas-container-${pedidoId}`).innerHTML = '';
        document.getElementById(`action-buttons-${pedidoId}`).style.display = 'none';
    }
});


    function calcularStatusEntrega(dataEntrega) {
        if (!dataEntrega) return "pendente";
        
        try {
            let dataEntregaObj;
            
            if (dataEntrega.toDate) {
                dataEntregaObj = dataEntrega.toDate();
            } 
            else if (typeof dataEntrega === 'string') {
                dataEntregaObj = new Date(dataEntrega);
            }
            else if (dataEntrega instanceof Date) {
                dataEntregaObj = dataEntrega;
            } else {
                return "pendente";
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            dataEntregaObj.setHours(0, 0, 0, 0);
            
            if (dataEntregaObj < hoje) return "atrasado";
            return "aprovado";
        } catch (e) {
            console.error("Erro ao calcular status de entrega:", e);
            return "pendente";
        }
    }

    // Eventos
    document.getElementById("search-btn").addEventListener("click", () => {
        const busca = document.getElementById("search-input").value.trim();
        carregarPedidos(busca);
    });

    document.getElementById("search-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            const busca = document.getElementById("search-input").value.trim();
            carregarPedidos(busca);
        }
    });

    // Inicia o carregamento quando a página estiver pronta
    document.addEventListener("DOMContentLoaded", () => {
        console.log("Página carregada, iniciando busca por pedidos...");
        carregarPedidos();
    });
</script>
</body>
</html>
